<%- include("../partials/header") %>
<div class="parking-complaint-text">
    <div class="parking-complaint">PARKING COMPLAINTS</div>
    <div class="complaint-text">This form is to address concerns regarding parking situations, experiences, and facilities at Chiang Mai University.</div>
</div>
<form action="/upload" id="upload" method="POST" enctype="multipart/form-data">
        <div class="location">
            <div class="location-text">LOCATION:</div>
            <label for="parkingSelect">Select Parking Area:</label>
            <select id="parkingSelect" name="parkingArea">
                <option value="" disabled selected>Select a parking area</option>
                <% parkingAreas.forEach(function(area) { %>
                    <option value="<%= area.name %>"><%= area.name %></option>
                <% }) %>
            </select>
            </div>  
    </div>

    <div class="issue">
        <div class="issue-text">ISSUE/CONCERNS:</div>
        <div class="input-issue-box">
            <textarea id="issue" name="issue" placeholder="Write something.." required></textarea>
        </div>
    </div>

    <div class="media-proof">
        <div class="media-proof-text">MEDIA PROOF:</div>
    </div>
    <div class="file-upload-container">
        <label for="myFile">
            <img src="/img/add-file.png" alt="Upload Image" class="file" />
        </label>
        <input type="file" id="myFile" name="filename[]" style="display: none;" multiple onchange="previewFiles()" />
        <div class="img" id="previewContainer"></div>
    </div>     
    
    <!-- <div class="img" id="previewContainer" style="display: none;">
        <span class="delete" onclick="removeFile()">&times;</span>
        <img id="previewImg" />
        <p id="fileName"></p>
    </div> -->
    
    <button type="submit" class="submit "id="submitBtn">Publish Complaint</button>
</form>

<script>
        let selectedFiles = [];

        window.onload = function() {
            document.querySelector("form").reset();
            document.getElementById("previewContainer").innerHTML = "";
        };

        function previewFiles() {
            const fileInput = document.getElementById("myFile");
            const files = Array.from(fileInput.files);
            const previewContainer = document.getElementById("previewContainer");

            selectedFiles = [...files];
            previewContainer.innerHTML = "";

            selectedFiles.forEach((file, index) => {
                const fileContainer = document.createElement("div");
                fileContainer.classList.add(file.type.startsWith('image/') ? "img" : "file-container");

                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement("img");
                        img.src = e.target.result;
                        fileContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                } else {
                    const fileIcon = document.createElement("div");
                    fileIcon.classList.add("file-icon");
                    fileIcon.innerHTML = "&#128196;"; 

                    const fileName = document.createElement("div");
                    fileName.classList.add("file-name");
                    fileName.textContent = file.name;

                    fileContainer.appendChild(fileIcon);
                    fileContainer.appendChild(fileName);
                }

                const deleteBtn = document.createElement("span");
                deleteBtn.classList.add("delete");
                deleteBtn.innerHTML = "&times;";
                deleteBtn.onclick = function() {
                    removeFile(index);
                };

                fileContainer.appendChild(deleteBtn);
                previewContainer.appendChild(fileContainer);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1); 
            const fileInput = document.getElementById("myFile");
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file)); 
            fileInput.files = dt.files;
            previewFiles();
        }

        document.querySelector("#complaintForm").onsubmit = function(event) {
            event.preventDefault();

            const formData = new FormData(this); // Create FormData from the form
            selectedFiles.forEach(file => {
                formData.append('myFile', file); // Append files to FormData
            });

            fetch('/submit-complaint', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Handle success or error response
                console.log(data);
                // Optionally reset the form or show a success message
                this.reset();
                document.getElementById("previewContainer").innerHTML = "";
                selectedFiles = [];
            })
            .catch(error => {
                console.error('Error:', error);
            });
        };
    </script>    